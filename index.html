<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H√ÑLYTYSVAHTI PRO V3</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --danger: #ff1111; --missing: #ffaa00; --bg: #000; --card: #111; }
        body { background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; margin: 0; }
        
        #map { height: 35vh; width: 100%; border-bottom: 2px solid #333; filter: invert(100%) hue-rotate(180deg) brightness(80%); }
        
        .container { padding: 15px; padding-bottom: 120px; }
        
        .header-tag { font-size: 0.7em; color: #888; text-transform: uppercase; margin-top: 15px; display: flex; align-items: center; }
        .header-tag::after { content: ""; flex: 1; height: 1px; background: #222; margin-left: 10px; }

        .card { 
            background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 10px; 
            border-left: 6px solid #333; transition: opacity 0.5s; 
        }
        .card.near { border-left-color: var(--danger); background: linear-gradient(90deg, #200 0%, #111 100%); }
        .card.missing { border-left-color: var(--missing); border-style: dashed; }
        
        #tos { 
            position: fixed; inset: 0; background: #000; z-index: 9999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px; text-align: center; 
        }
        button.start-btn { 
            padding: 22px 50px; background: var(--danger); color: white; border: none; 
            border-radius: 50px; font-weight: bold; font-size: 1.2em; box-shadow: 0 0 20px rgba(255,17,17,0.4); 
        }
        
        .status-bar { font-size: 0.7em; background: #0a0a0a; padding: 5px; text-align: center; color: #0f0; border-bottom: 1px solid #222; }
    </style>
</head>
<body>

<div id="tos">
    <h1 style="margin-bottom: 10px;">üö® PRO-VAHTI V3</h1>
    <p style="font-size: 0.9em; color: #ccc;">√Ñlyk√§s h√§lytysten seuranta. <br>Hakee tiedot 5 eri l√§hteest√§ ilman toistoa.</p>
    <p style="color: var(--danger); font-weight: bold; font-size: 0.8em;">KIELTO: √ÑL√Ñ MENE ONNETTOMUUSPAIKOILLE.</p>
    <br>
    <button class="start-btn" onclick="startApp()">AKTIVOI VALVONTA</button>
</div>

<div class="status-bar" id="status">ODOTETAAN AKTIVOINTIA...</div>
<div id="map"></div>

<div class="container">
    <div class="header-tag">üë• Kadonneet & Poliisi</div>
    <div id="missing-list"></div>

    <div class="header-tag">üî• H√§lytykset & Liikenne</div>
    <div id="alert-list"></div>
</div>

<script>
    let map, userMarker, myCity = "";
    let processedIds = new Set(); // Est√§√§ t√§ysin samat ID:t
    let processedTitles = new Set(); // Est√§√§ eri l√§hteiden samanlaiset otsikot
    const synth = window.speechSynthesis;
    let isAppRunning = false;

    // Her√§tys√§√§ni her√§tt√§m√§√§n puhelin taustalta
    const alertBeep = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');

    async function startApp() {
        document.getElementById('tos').style.display = 'none';
        isAppRunning = true;
        
        // Aktivoi √§√§ni mobiiliselaimelle
        synth.speak(new SpeechSynthesisUtterance('Valvonta k√§ynnistetty'));
        
        initMap();
        fetchData();
        setInterval(fetchData, 25000); // 25s p√§ivitysv√§li on optimaalinen akulle
    }

    function initMap() {
        navigator.geolocation.watchPosition(pos => {
            const { latitude, longitude } = pos.coords;
            if (!map) {
                map = L.map('map', {zoomControl: false}).setView([latitude, longitude], 11);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                userMarker = L.circleMarker([latitude, longitude], {radius: 7, color: '#007bff', fillOpacity: 1}).addTo(map);
                document.getElementById('status').innerText = "üîã AKKUS√Ñ√ÑST√ñ / GPS OK";
            }
            userMarker.setLatLng([latitude, longitude]);
            if (!myCity) fetchCity();
        }, null, { enableHighAccuracy: false });
    }

    async function fetchCity() {
        try {
            const r = await fetch('https://ipapi.co/json/');
            const d = await r.json();
            myCity = d.city;
        } catch(e) {}
    }

    async function fetchData() {
        try {
            const r = await fetch('/api/full_feed');
            const data = await r.json();
            
            // K√§sittele uusin tieto ensin
            data.reverse().forEach(item => {
                const titleNorm = item.title.toLowerCase().trim().replace(/[^\w\s]/g, '');
                
                // TARKISTUS: Onko jo n√§hty (ID tai samankaltainen otsikko)?
                if (!processedIds.has(item.id) && !processedTitles.has(titleNorm)) {
                    processedIds.add(item.id);
                    processedTitles.add(titleNorm);
                    
                    // Rajoitetaan listan kokoa muistissa
                    if (processedTitles.size > 100) processedTitles.clear();

                    renderAlert(item);
                }
            });
        } catch(e) { console.log("Yhteysvirhe"); }
    }

    function renderAlert(item) {
        const title = item.title.toLowerCase();
        const summary = item.summary.toLowerCase();
        const text = title + " " + summary;

        // Tunnistuslogiikka
        const isMissing = text.includes("kadonnut") || text.includes("etsit√§√§n") || text.includes("havaintoja");
        const isNear = myCity && text.includes(myCity.toLowerCase());
        const isHwy = /(vt\d+|e\d+|valtatie|kantatie|keh√§)/i.test(title);

        // Luo kortti
        const card = document.createElement('div');
        card.className = `card ${isMissing ? 'missing' : ''} ${isNear ? 'near' : ''}`;
        card.innerHTML = `<small style="color:#666">${item.source}</small><div style="font-weight:bold; margin-top:4px;">${item.title}</div>`;

        if (isMissing) {
            document.getElementById('missing-list').prepend(card);
        } else {
            document.getElementById('alert-list').prepend(card);
        }

        // PUHE JA TAUSTATOIMINTA
        if (isNear || isHwy || item.source === "VAARA_112") {
            announce(item, isMissing, isNear);
        }
    }

    function announce(item, isMissing, isNear) {
        // 1. Soita lyhyt her√§tys√§√§ni
        alertBeep.play().catch(() => {});

        // 2. Puhu ilmoitus
        setTimeout(() => {
            const msg = isMissing ? `Huomio. Kadonnut henkil√∂ alueella ${myCity || ''}. ${item.title}` : item.title;
            const u = new SpeechSynthesisUtterance(msg);
            u.lang = 'fi-FI';
            u.rate = 0.95;
            synth.speak(u);
        }, 500);
    }
</script>
</body>
</html>
