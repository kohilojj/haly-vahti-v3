<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GLOBAL PRO-VAHTI</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --accent: #007aff; --bg: #000; --card: #1c1c1e; }
        body { background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; margin: 0; overflow: hidden; }
        
        /* Side Menu */
        #side-menu {
            position: fixed; left: -280px; top: 0; bottom: 0; width: 250px;
            background: #111; z-index: 10001; transition: 0.3s; padding: 20px;
            border-right: 1px solid #333;
        }
        #side-menu.open { left: 0; }
        .menu-item { padding: 15px 0; border-bottom: 1px solid #222; cursor: pointer; display: flex; align-items: center; gap: 10px; }

        /* Connection Warning */
        #net-warning {
            display: none; background: #ff3b30; color: white; text-align: center;
            padding: 5px; font-size: 0.8em; font-weight: bold;
        }

        #setup-screen { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .btn { background: var(--accent); color: white; border: none; padding: 15px 30px; border-radius: 12px; font-weight: bold; width: 250px; margin: 10px; }
        
        #map { height: 250px; margin: 15px; border-radius: 15px; filter: invert(100%) hue-rotate(180deg); }
        .outage-alert { border-left: 6px solid #ff9500 !important; background: #2a1a00 !important; }
    </style>
</head>
<body>

<div id="net-warning">⚠️ YHTEYSVIRHE: AI analysoi syytä... (Heikko signaali)</div>

<div id="side-menu">
    <h3>Valikko</h3>
    <div class="menu-item" onclick="showTerms()"><i class="fa-solid fa-file-contract"></i> Käyttöehdot</div>
    <div class="menu-item" onclick="location.reload()"><i class="fa-solid fa-rotate"></i> Resetoi sovellus</div>
    <p style="font-size: 0.6em; color: #444; position: absolute; bottom: 20px;">v4.0 Global AI Edition</p>
</div>

<div id="setup-screen">
    <h1>GLOBAL AI VAHTI</h1>
    <select id="country" style="padding:15px; width:250px; border-radius:10px; background:#222; color:white;">
        <option value="FI">Suomi</option>
        <option value="SE">Sverige</option>
        <option value="US">USA</option>
    </select>
    <select id="lang" style="padding:15px; width:250px; border-radius:10px; background:#222; color:white; margin: 10px;">
        <option value="fi">Suomi</option>
        <option value="en">English</option>
        <option value="sv">Svenska</option>
    </select>
    <div style="font-size: 0.7em; color: #666; margin: 15px; max-width: 250px;">
        Hyväksyn, että sovellus käyttää GPS-tietoja ja AI-analyysia turvallisuuden parantamiseksi.
    </div>
    <button class="btn" onclick="launch()">HYVÄKSY JA ALOITA</button>
</div>

<div id="app-content" style="display:none;">
    <header style="padding: 15px; display: flex; justify-content: space-between; align-items: center; background: #111;">
        <i class="fa-solid fa-bars" onclick="document.getElementById('side-menu').classList.toggle('open')"></i>
        <b id="status-text">AI AKTIIVINEN</b>
        <div id="temp-badge">--°</div>
    </header>

    <div id="map"></div>
    <div id="feed" style="padding: 15px;"></div>
</div>

<script>
    let config = { country: 'FI', lang: 'fi' };
    let synth = window.speechSynthesis;

    function launch() {
        config.country = document.getElementById('country').value;
        config.lang = document.getElementById('lang').value;
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        initApp();
    }

    function initApp() {
        // Yhteysvahti
        window.addEventListener('offline', () => {
            document.getElementById('net-warning').style.display = 'block';
            speak(config.lang === 'fi' ? "Yhteys katkesi. AI tarkistaa reititintä." : "Connection lost.");
        });
        window.addEventListener('online', () => {
            document.getElementById('net-warning').style.display = 'none';
        });

        navigator.geolocation.getCurrentPosition(pos => {
            const { latitude, longitude } = pos.coords;
            let map = L.map('map', {zoomControl:false}).setView([latitude, longitude], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            updateLoop(latitude, longitude);
        });
    }

    async function updateLoop(lat, lon) {
        // Sää-AI
        const wr = await fetch(`/api/weather_analysis?lat=${lat}&lon=${lon}&lang=${config.lang}`);
        const wd = await wr.json();
        document.getElementById('temp-badge').innerText = Math.round(wd.temp) + "°";
        document.getElementById('status-text').innerText = wd.analysis;

        // Hälytykset
        const fr = await fetch(`/api/full_feed?country=${config.country}`);
        const fd = await fr.json();
        const container = document.getElementById('feed');
        container.innerHTML = '';
        
        fd.forEach(item => {
            const card = document.createElement('div');
            card.className = `alert-card ${item.is_outage ? 'outage-alert' : ''}`;
            card.style = "background:#1c1c1e; padding:15px; margin-bottom:10px; border-radius:12px; border:1px solid #333;";
            card.innerHTML = `<small style="color:var(--accent)">${item.source}</small><div>${item.title}</div>`;
            container.appendChild(card);
            
            if (item.is_outage) {
                speak(config.lang === 'fi' ? "Sähkökatko havaittu lähialueella." : "Power outage detected.");
            }
        });
        
        setTimeout(() => updateLoop(lat, lon), 40000);
    }

    function speak(text) {
        synth.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = config.lang === 'fi' ? 'fi-FI' : (config.lang === 'sv' ? 'sv-SE' : 'en-US');
        synth.speak(u);
    }

    function showTerms() {
        alert("KÄYTTÖEHDOT:\n1. Sovellus tarjoaa vain suuntaa-antavaa tietoa.\n2. Älä käytä sovellusta ajaessasi käsin.\n3. AI-analyysi perustuu julkisiin lähteisiin.");
    }
</script>
</body>
</html>
