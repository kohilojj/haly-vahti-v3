<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HÃ„LYTYSVAHTI ULTIMATE</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { 
            --danger: #ff1111; 
            --hwy: #00ff00; 
            --missing: #ffcc00; 
            --bg: #000; 
            --card: #121212; 
        }
        
        body { 
            background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; 
            margin: 0; padding: 0; overflow-x: hidden; touch-action: manipulation;
        }

        /* Akun sÃ¤Ã¤stÃ¶: Kartta on himmeÃ¤mpi ja pieni */
        #map { height: 30vh; width: 100%; border-bottom: 2px solid #222; filter: grayscale(1) contrast(1.2) invert(100%); opacity: 0.7; }

        .container { padding: 12px; padding-bottom: 100px; }

        h2 { font-size: 0.9em; color: #888; text-transform: uppercase; letter-spacing: 1px; margin: 20px 0 10px 0; display: flex; align-items: center; }
        h2::after { content: ""; flex: 1; height: 1px; background: #333; margin-left: 10px; }

        /* MobiiliystÃ¤vÃ¤lliset kortit */
        .card {
            background: var(--card); border-radius: 12px; padding: 15px; 
            margin-bottom: 12px; border-left: 6px solid #333;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: transform 0.1s;
        }
        
        /* Erikoistyylit */
        .card.near { border-left-color: var(--danger); background: linear-gradient(90deg, #200 0%, #121212 100%); }
        .card.missing { border-left-color: var(--missing); border-style: dashed; }
        .card.found { opacity: 0.4; border-left-color: #00ff00; }
        
        .found-label { color: #00ff00; font-weight: bold; font-size: 0.8em; margin-top: 5px; display: block; }
        
        /* Aloitusruutu / TOS */
        #tos-overlay {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 30px; text-align: center;
        }
        
        .tos-box { max-width: 400px; border: 1px solid #333; padding: 25px; border-radius: 20px; background: #0a0a0a; }
        
        button#start-btn {
            width: 100%; padding: 20px; background: var(--danger); color: white;
            border: none; border-radius: 50px; font-weight: bold; font-size: 1.1em;
            margin-top: 20px; cursor: pointer; box-shadow: 0 0 20px rgba(255,17,17,0.3);
        }

        .status-bar { background: #0a0a0a; font-size: 0.7em; color: #00ff00; padding: 5px; text-align: center; border-bottom: 1px solid #222; }
    </style>
</head>
<body>

<div id="tos-overlay">
    <div class="tos-box">
        <h1 style="color:var(--danger)">PRO-VAHTI</h1>
        <p style="font-weight: bold;">KÃ„YTTÃ–EHDOT & TURVALLISUUS</p>
        <p style="font-size: 0.85em; color: #ccc; line-height: 1.5;">
            1. Onnettomuuspaikoille meno on KIELLETTY.<br>
            2. Sovellus kuluttaa GPS-virtaa.<br>
            3. Puhe toimii taustalla, kunhan selain on auki.<br>
            4. Kadonneet-tiedot ovat vain viranomaisilta.
        </p>
        <button id="start-btn" onclick="initApp()">HYVÃ„KSYN JA ALOITAN</button>
    </div>
</div>

<div class="status-bar" id="gps-status">ODOTETAAN AKTIVOINTIA...</div>
<div id="map"></div>

<div class="container">
    <div id="missing-box">
        <h2>ðŸ‘¥ Kadonneet Alueellasi</h2>
        <div id="missing-list"></div>
    </div>

    <div id="alert-box">
        <h2>ðŸ”¥ HÃ¤lytykset & Liikenne</h2>
        <div id="feed"></div>
    </div>
</div>

<script>
    let map, userMarker, myCity = "";
    let seenAlerts = new Set();
    let missingMap = new Map(); // Seurataan kadonneita
    const synth = window.speechSynthesis;
    let isVisible = true;

    // SireeniherÃ¤tys mobiilille
    const piippa = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');

    document.addEventListener("visibilitychange", () => { isVisible = !document.hidden; });

    async function initApp() {
        document.getElementById('tos-overlay').style.display = 'none';
        
        // Aktivoi audio-kanava
        synth.speak(new SpeechSynthesisUtterance('Valvonta kÃ¤ynnistetty. Turvallista matkaa.'));

        startGPS();
        setInterval(fetchUpdates, 20000); // AkkuystÃ¤vÃ¤llinen 20s vÃ¤li
        fetchUpdates();
    }

    function startGPS() {
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(pos => {
                const { latitude, longitude } = pos.coords;
                if (isVisible) {
                    if (!map) {
                        map = L.map('map', {zoomControl: false}).setView([latitude, longitude], 12);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                        userMarker = L.circleMarker([latitude, longitude], {radius: 7, color: '#007bff', fillOpacity: 1}).addTo(map);
                    }
                    userMarker.setLatLng([latitude, longitude]);
                    document.getElementById('gps-status').innerText = `ðŸ”‹ AKKUSÃ„Ã„STÃ– PÃ„Ã„LLÃ„ - GPS OK`;
                }
                if (!myCity) getCityName();
            }, null, { enableHighAccuracy: false });
        }
    }

    async function getCityName() {
        try {
            const r = await fetch('https://ipapi.co/json/');
            const d = await r.json();
            myCity = d.city;
        } catch(e) { myCity = "Suomi"; }
    }

    async function fetchUpdates() {
        try {
            const r = await fetch('/api/full_feed');
            const data = await r.json();
            
            // Tarkista kadonneiden tilanne (onko poistunut feedistÃ¤ = lÃ¶ydetty)
            const currentIDs = new Set(data.map(i => i.id));
            missingMap.forEach((val, id) => {
                if (!currentIDs.has(id) && !val.found) {
                    val.found = true;
                    updateMissingUI();
                }
            });

            data.reverse().forEach(item => {
                const text = (item.title + " " + item.summary).toLowerCase();
                const isMissing = text.includes("kadonnut") || text.includes("etsitÃ¤Ã¤n") || text.includes("kaivataan");

                if (isMissing) {
                    if (!missingMap.has(item.id)) {
                        missingMap.set(item.id, { ...item, found: false });
                        updateMissingUI();
                        if (myCity && text.includes(myCity.toLowerCase())) {
                            triggerVoice(`Huomio. Kadonnut henkilÃ¶ alueella ${myCity}.`);
                        }
                    }
                } else if (!seenAlerts.has(item.id)) {
                    seenAlerts.add(item.id);
                    handleNewAlert(item, text);
                }
            });
        } catch(e) { console.log("Haku epÃ¤onnistui"); }
    }

    function updateMissingUI() {
        const list = document.getElementById('missing-list');
        list.innerHTML = "";
        missingMap.forEach(item => {
            const isNear = myCity && item.title.toLowerCase().includes(myCity.toLowerCase());
            const card = document.createElement('div');
            card.className = `card missing ${isNear ? 'near' : ''} ${item.found ? 'found' : ''}`;
            card.innerHTML = `
                <small style="color:var(--missing)">POLIISI</small>
                <div style="font-weight:bold; margin-top:3px;">${item.title}</div>
                ${item.found ? '<span class="found-label">âœ“ HENKILÃ– LÃ–YTYNYT / TILANNE OHI</span>' : ''}
            `;
            list.prepend(card);
        });
    }

    function handleNewAlert(item, text) {
        const isNear = myCity && text.includes(myCity.toLowerCase());
        const isHwy = /(vt\d+|e\d+|valtatie|kehÃ¤|kantatie)/i.test(text);

        if (isVisible) {
            const f = document.getElementById('feed');
            const card = document.createElement('div');
            card.className = `card ${isNear ? 'near' : ''}`;
            card.innerHTML = `<small style="color:#666">${item.source}</small><div style="font-weight:bold; margin-top:3px;">${item.title}</div>`;
            f.prepend(card);
            if (f.childNodes.length > 10) f.removeChild(f.lastChild);
        }

        // PUHE-LOGIIKKA (Toimii taustalla)
        if (isNear || isHwy || item.source === "VAARA") {
            triggerVoice(isNear ? `HÃ¤lytys lÃ¤hellÃ¤. ${item.title}` : `Tieilmoitus. ${item.title}`);
        }
    }

    function triggerVoice(txt) {
        piippa.play().catch(() => {});
        setTimeout(() => {
            const u = new SpeechSynthesisUtterance(txt);
            u.lang = 'fi-FI';
            u.rate = 0.9;
            synth.speak(u);
        }, 600);
    }
</script>
</body>
</html>
